#!/bin/sh

set -e # DIE on errors

. /usr/share/dtc-xen/dtc-xen-parse-param

VPSNAME=${VPSNUM}
HALFMEM=$((VPSMEM / 2))
QUARTERMEM=$((VPSMEM / 4))
PRIVMPAGESHARD=$((HALFMEM * 11 / 10))
HDDHARD=$((VPSHDD * 11 / 10))
INODES=$((VPSHDD / 4))
INODESHARD=$((INODES * 11 / 10))

#################################
### VZ STARTUP FILE CREATION ###
#################################
if [ ! -z "${MAC_ADDR}" ] ; then
	XEN_WRITE_MAC="mac=${MAC_ADDR}, "
else
	XEN_WRITE_MAC=""
fi

echo -n "ONBOOT=\"yes\"
# Primary parameters
NUMPROC=\"1024:1024\"
NUMTCPSOCK=\"9223372036854775807:9223372036854775807\"
NUMOTHERSOCK=\"9223372036854775807:9223372036854775807\"
VMGUARPAGES=\"${HALFMEM}:9223372036854775807\"

# Secondary parameters
KMEMSIZE=\"9223372036854775807:9223372036854775807\"
OOMGUARPAGES=\"${HALFMEM}:9223372036854775807\"
PRIVVMPAGES=\"${HALFMEM}:${PRIVMPAGESHARD}\"
TCPSNDBUF=\"9223372036854775807:9223372036854775807\"
TCPRCVBUF=\"9223372036854775807:9223372036854775807\"
OTHERSOCKBUF=\"9223372036854775807:9223372036854775807\"
DGRAMRCVBUF=\"9223372036854775807:9223372036854775807\"

# Auxiliary parameters
NUMFILE=\"9223372036854775807:9223372036854775807\"
NUMFLOCK=\"9223372036854775807:9223372036854775807\"
NUMPTY=\"255:255\"
NUMSIGINFO=\"1024:1024\"
DCACHESIZE=\"9223372036854775807:9223372036854775807\"
LOCKEDPAGES=\"${QUARTERMEM}:${QUARTERMEM}\"
SHMPAGES=\"9223372036854775807:9223372036854775807\"
NUMIPTENT=\"9223372036854775807:9223372036854775807\"
PHYSPAGES=\"0:9223372036854775807\"

# Disk quota parameters
DISKSPACE=\"${VPSHDD}:${HDDHARD}\"
DISKINODES=\"${INODES}:${INODESHARD}\"
QUOTATIME=\"0\"
QUOTAUGIDLIMIT=\"0\"

# CPU fair sheduler parameter
CPUUNITS=\"1000\"
CPUS=\"1\"
CPULIMIT=\"10\"
VE_ROOT=\"/var/lib/dtc-xen/mnt/${VPSNUM}\"
VE_PRIVATE=\"/var/lib/vz/private/${VPSNUM}\"
OSTEMPLATE=\"ubuntu-8.0-standard_8.04-1_i386\"
ORIGIN_SAMPLE=\"\"
IP_ADDRESS=\"${FIRST_IP}\"
HOSTNAME=\"${VPS_FQDN}\"
DESCRIPTION=\"\"
NAMESERVER=\"${DNS}\"
SEARCHDOMAIN=\"\"
NETIF=\"ifname=venet0,mac=${XEN_WRITE_MAC},host_mac=${XEN_WRITE_MAC}\"

" >/etc/vz/conf/${VPSNAME}
